
@* 
@model IEnumerable<MadrasahManagement.Models.IssuedBook>

@{
    ViewData["Title"] = "Issued Books";
}

<div class="container">
    <h1>Issued Books</h1>

    <div class="mb-3">
        <a asp-action="Create" class="btn btn-primary">Issue New Book</a>
        @* <a asp-action="CurrentIssues" class="btn btn-info">View Current Issues</a>
        <a asp-action="Overdue" class="btn btn-warning">View Overdue</a> *@
@*     </div>

    <table class="table table-striped table-bordered">
        <thead class="thead-dark">
            <tr>
                <th>Book</th>
                <th>Issued To</th>
                <th>Issue Date</th>
                <th>Return Date</th>
                <th>Fine</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td>@item.Book?.Title</td>
                    <td>@item.AppUser?.UserName</td>
                    <td>@item.IssueDate.ToString("MMM dd, yyyy")</td>
                    <td>@(item.ReturnDate?.ToString("MMM dd, yyyy") ?? "Not Returned")</td>
                    <td>@item.Fine.ToString("C")</td>
                    <td>
                        @if (item.ReturnDate == null)
                        {
                            <span class="badge badge-warning bg-warning">Issued</span>
                        }
                        else
                        {
                            <span class="badge badge-success bg-success">Returned</span>
                        }
                    </td>
                    <td>
                        <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-secondary btn-sm">Edit</a>
                        <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-info btn-sm">Details</a>
                        @if (item.ReturnDate == null)
                        {
                            <a asp-action="Return" asp-route-id="@item.Id" class="btn btn-success btn-sm">Return</a>
                        }
                        <a asp-action="Delete" asp-route-id="@item.Id" class="btn btn-danger btn-sm">Delete</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div> *@


@model IEnumerable<MadrasahManagement.Models.IssuedBook>

@{
    ViewData["Title"] = "Issued Books";
    var groupedIssues = Model.GroupBy(i => i.IssuedTo);
}

<div class="container">
    <h1>Issued Books</h1>

    <div class="mb-3">
        <a asp-action="Create" class="btn btn-primary">Issue New Book</a>
        <a class="btn btn-primary" asp-controller="Book" asp-action="Index">Book List</a>
    </div>

    <table class="table table-striped table-bordered">
        <thead class="thead-dark">
            <tr>
                
                <th>Issued To</th>
                <th>Book</th>
                <th>Issue Date</th>
                <th>Return Date</th>
                <th>Fine</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
          

            @foreach (var userGroup in groupedIssues)
            {
                var firstIssue = userGroup.First();
                <tr>
                    <td>@firstIssue.AppUser?.UserName</td>
                    <td>
                        @foreach (var issue in userGroup)
                        {
                            <div>@issue.Book?.Title</div>
                        }
                    </td>
                    <td>@firstIssue.IssueDate.ToString("MMM dd, yyyy")</td>
                    <td>@(firstIssue.ReturnDate?.ToString("MMM dd, yyyy") ?? "Not Returned")</td>
                    <td>@firstIssue.Fine.ToString("C")</td>
                    <td>
                        @if (userGroup.Any(i => i.ReturnDate == null))
                        {
                            <span >Some Books Pending</span>
                        }
                        else
                        {
                            <span >All Returned</span>
                        }
                    </td>
                    <td>
                        <a asp-action="Edit" asp-route-id="@firstIssue.Id" class="btn btn-secondary btn-sm">Edit</a>
                    
                        @if (firstIssue.ReturnDate == null)
                        {
                            <a asp-action="Return" asp-route-id="@firstIssue.Id" class="btn btn-success btn-sm">Return</a>
                        }
                        <a asp-action="Delete" asp-route-id="@firstIssue.Id" class="btn btn-danger btn-sm">Delete</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>
