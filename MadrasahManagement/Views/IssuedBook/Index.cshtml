@model IEnumerable<MadrasahManagement.Models.IssuedBook>

@{
    ViewData["Title"] = "Issued Books";
    var groupedIssues = Model.GroupBy(i => i.IssuedTo);
}

<div class="container">
   
    <h1 class="text-center">Issued Books</h1>
    <div class="mb-3 d-flex justify-content-between ">
        <a asp-action="Create" class="btn btn-success">Issue New Book</a>
        <a asp-action="ReturnedBooks" class="btn btn-info ms-2">View Returned Books</a>
    </div>

    <table class="table table-striped table-bordered">
        <thead class="table-success">
            <tr class="text-center">
                <th>Issued To</th>
                <th>Book</th>
                <th>Issue Date</th>
                <th>Return Date</th>
                <th>Fine</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody class="text-center">
            @foreach (var userGroup in groupedIssues)
            {
                var bookCount = userGroup.Count();
                var firstIssue = userGroup.First();

                @for (int i = 0; i < bookCount; i++)
                {
                    var issue = userGroup.ElementAt(i);
                    <tr>
                        @if (i == 0)
                        {
                            <td rowspan="@bookCount" style="vertical-align: middle;">
                                @firstIssue.AppUser?.UserName
                            </td>
                        }

                        <td>@issue.Book?.Title</td>
                        <td>@issue.IssueDate.ToString("MMM dd, yyyy")</td>
                        <td>@(issue.ReturnDate?.ToString("MMM dd, yyyy") ?? "Not Returned")</td>
                        <td class="@(issue.Fine > 0 ? "text-danger" : "text-success")">
                            @issue.Fine.ToString("C")
                        </td>
                        <td>
                            @if (issue.ReturnDate == null)
                            {
                                <a asp-action="Return" asp-route-id="@issue.Id" class="btn btn-success btn-sm mb-1">Return</a>
                                <span class="text-warning">Issued</span>
                            }
                            else
                            {
                                <span class="text-success">Returned</span>
                            }
                        </td>

                        @if (i == 0)
                        {
                            <td rowspan="@bookCount" style="vertical-align: middle;">
                                <div class="d-flex flex-column gap-1 mt-2">                                 
                                    <a asp-action="Edit" asp-route-userId="@firstIssue.IssuedTo"
                                       class="btn btn-secondary btn-sm">Edit All</a>
                                    <a asp-action="Details" asp-route-userId="@firstIssue.IssuedTo"
                                       class="btn btn-info btn-sm">Details</a>
                                   
                                   @*  <a asp-action="Delete" asp-route-userId="@firstIssue.IssuedTo"
                                       class="btn btn-danger btn-sm">Delete All</a> *@
                                </div>
                            </td>
                        }
                    </tr>
                
                }
               
            }
       
           
       
        </tbody>
    </table>
</div>

@* @model IEnumerable<MadrasahManagement.Models.IssuedBook>

@{
    ViewData["Title"] = "Issued Books";
    var groupedIssues = Model.GroupBy(i => i.IssuedTo);
}

<div class="container">
    <h1>Issued Books</h1>

    <div class="mb-3">
        <a asp-action="Create" class="btn btn-primary">Issue New Book</a>

    </div>

    <table class="table table-striped table-bordered">
        <thead class="thead-dark">
            <tr class="text-center">
                
                <th>Issued To</th>
                <th>Book</th>
                <th>Issue Date</th>
                <th>Return Date</th>
                <th>Fine</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody class="text-center">
          

            @foreach (var userGroup in groupedIssues)
            {
                var firstIssue = userGroup.First();
                <tr>
                    <td>@firstIssue.AppUser?.UserName</td>
                    <td>
                        @foreach (var issue in userGroup)
                        {
                            <div>@issue.Book?.Title</div>
                        }
                    </td>
                    <td>@firstIssue.IssueDate.ToString("MMM dd, yyyy")</td>
                    <td>@(firstIssue.ReturnDate?.ToString("MMM dd, yyyy") ?? "Not Returned")</td>
                    <td>@firstIssue.Fine.ToString("C")</td>
                 @*    <td>
                        @if (userGroup.Any(i => i.ReturnDate == null))
                        {
                            <span >Some Books Pending</span>
                        }
                        else
                        {
                            <span >All Returned</span>
                        }
                    </td> *@

@*        <td>
                        <!-- Individual actions for each book -->
                        <div class="btn-group-vertical">
                            @foreach (var issue in userGroup)
                            {
                                <div class="d-flex gap-1 mb-1">
                                    <span class="mr-2">@issue.Book?.Title.Substring(0, Math.Min(20, issue.Book.Title.Length))...</span>
                                    @if (issue.ReturnDate == null)
                                    {
                                        <a asp-action="Return" asp-route-id="@issue.Id" class="btn btn-success btn-sm">Return</a>
                                    }
                                  
                                </div>
                            }
                        </div> *@

@*  <!-- Bulk return for all -->
                        @if (userGroup.Any(i => i.ReturnDate == null))
                        {
                            <div class="mt-2">
                                <a asp-action="ReturnUserBooks" asp-route-userId="@firstIssue.IssuedTo"
                                   class="btn btn-warning btn-sm">Return All for @firstIssue.AppUser?.UserName</a>
                            </div>
                        } *@
@*   </td>

                    <td class="text-center">
                        <a asp-action="Edit" asp-route-id="@firstIssue.Id" class="btn btn-secondary ">Edit</a>
                        <a asp-action="Details" asp-route-id="@firstIssue.Id" class="btn btn-info ">Details</a>
                       
                        <a asp-action="Delete" asp-route-id="@firstIssue.Id" class="btn btn-danger ">Delete</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>
 *@


@* 
@model IEnumerable<MadrasahManagement.Models.IssuedBook>

@{
    ViewData["Title"] = "Issued Books";
}

<div class="container">
    <h1>Issued Books</h1>

    <div class="mb-3">
        <a asp-action="Create" class="btn btn-primary">Issue New Book</a>
        @* <a asp-action="CurrentIssues" class="btn btn-info">View Current Issues</a>
        <a asp-action="Overdue" class="btn btn-warning">View Overdue</a> *@
@*     </div>

    <table class="table table-striped table-bordered">
        <thead class="thead-dark">
            <tr>
                <th>Book</th>
                <th>Issued To</th>
                <th>Issue Date</th>
                <th>Return Date</th>
                <th>Fine</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td>@item.Book?.Title</td>
                    <td>@item.AppUser?.UserName</td>
                    <td>@item.IssueDate.ToString("MMM dd, yyyy")</td>
                    <td>@(item.ReturnDate?.ToString("MMM dd, yyyy") ?? "Not Returned")</td>
                    <td>@item.Fine.ToString("C")</td>
                    <td>
                        @if (item.ReturnDate == null)
                        {
                            <span class="badge badge-warning bg-warning">Issued</span>
                        }
                        else
                        {
                            <span class="badge badge-success bg-success">Returned</span>
                        }
                    </td>
                    <td>
                        <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-secondary btn-sm">Edit</a>
                        <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-info btn-sm">Details</a>
                        @if (item.ReturnDate == null)
                        {
                            <a asp-action="Return" asp-route-id="@item.Id" class="btn btn-success btn-sm">Return</a>
                        }
                        <a asp-action="Delete" asp-route-id="@item.Id" class="btn btn-danger btn-sm">Delete</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div> *@
