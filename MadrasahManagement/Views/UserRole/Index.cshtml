@using MadrasahManagement.ViewModels
@using Microsoft.AspNetCore.Identity
@model List<UserRoleViewModel>
@inject RoleManager<AppRole> RoleManager

<div class="container mt-4">
    <h3 class="mb-4 text-primary">🌟 User Role Management </h3>

    <div class="mb-3">
        <a href="/Account/Register" class="btn btn-primary">
            <i class="bi bi-person-plus"></i> Create New User
        </a>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-3">
            <table class="table table-hover align-middle" id="roleTable">
                <thead class="table-dark">
                    <tr>
                        <th>Email</th>
                        <th>Roles</th>
                        <th>Add Role</th>
                        <th>Delete User</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in Model)
                    {
                        <tr id="row-@user.UserId" class="table-light">
                            <td class="fw-bold">@user.Email</td>

                            <td id="roles-@user.UserId">
                                @foreach (var r in user.Roles)
                                {
                                    var badgeColor = r switch
                                    {
                                        "Admin" => "bg-danger",
                                        "Student" => "bg-success",
                                        "Teacher" => "bg-warning text-dark",
                                        _ => "bg-info text-dark"
                                    };
                                    <span class="badge @badgeColor me-1" data-bs-toggle="tooltip" title="Click X to remove">
                                        @r
                                        <button class="btn btn-sm btn-light remove-role ms-1" data-user="@user.UserId" data-role="@r">
                                            <i class="bi bi-x-circle text-danger"></i>
                                        </button>
                                    </span>
                                }
                            </td>

                            <td>
                                <div class="d-flex gap-2">
                                    <select class="form-select role-select" id="select-@user.UserId">
                                        @foreach (var role in RoleManager.Roles)
                                        {
                                            <option value="@role.Name">@role.Name</option>
                                        }
                                    </select>
                                    <button class="btn btn-success btn-sm assign-role" data-user="@user.UserId">
                                        <i class="bi bi-plus-circle"></i> Assign
                                    </button>
                                </div>
                            </td>

                            <td>
                                <button class="btn btn-danger btn-sm delete-user" data-user="@user.UserId">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>
        // Enable Bootstrap tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl)
        })

        // Initialize DataTable
        $(document).ready(function () {
            $('#roleTable').DataTable({
                "pageLength": 10,
                "lengthMenu": [5, 10, 25, 50],
                "order": [[0, "asc"]]
            });
        });

        // Assign role AJAX
        $(".assign-role").click(function () {
            let userId = $(this).data("user");
            let role = $("#select-" + userId).val();
            $.post("/UserRole/AssignRoleAjax", { userId: userId, role: role }, function (data) {
                if (data.success) updateRoleList(userId, data.roles);
            });
        });

        // Remove role AJAX
        $(document).on("click", ".remove-role", function () {
            let userId = $(this).data("user");
            let role = $(this).data("role");
            $.post("/UserRole/RemoveRoleAjax", { userId: userId, role: role }, function (data) {
                if (data.success) updateRoleList(userId, data.roles);
            });
        });

        // Delete user AJAX
        $(document).on("click", ".delete-user", function () {
            if (!confirm("Delete this user?")) return;
            let userId = $(this).data("user");
            $.post("/UserRole/DeleteUserAjax", { userId: userId }, function (data) {
                if (data.success) {
                    $('#roleTable').DataTable().row($('#row-' + userId)).remove().draw();
                }
            });
        });

        // Update roles dynamically
        function updateRoleList(userId, roles) {
            let html = "";
            roles.forEach(r => {
                let badgeColor = r === "Admin" ? "bg-danger" : r === "Student" ? "bg-success" : "bg-info text-dark";
                html += `<span class="badge ${badgeColor} me-1">
                            ${r}
                            <button class="btn btn-sm btn-light remove-role ms-1" data-user="${userId}" data-role="${r}">
                                <i class="bi bi-x-circle text-danger"></i>
                            </button>
                         </span>`;
            });
            $("#roles-" + userId).html(html);
        }
    </script>
}
